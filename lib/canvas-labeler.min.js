!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("CanvasLabeler",[],e):"object"==typeof exports?exports.CanvasLabeler=e():t.CanvasLabeler=e()}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>S});const i=function(t,e){this.label="",this.coor=[],this.strokeStyle="",this.fillStyle="",this.labelFillStyle="",this.textFillStyle="",this.labelFont="",this.type=0,this.active=!1,this.creating=!1,this.dragging=!1,this.uuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++){var s=Math.floor(16*Math.random());t[i]=e.slice(s,s+1)}t[14]="4";var o=3&t[19]|8;return t[19]=e.slice(o,o+1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}(),this.index=e,Object.assign(this,t)};var s,o=(s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},s(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});const n=function(t){function e(e,i,s){void 0===s&&(s=1);var o=t.call(this,e,i)||this;return o.type=1,o.type=s,o}return o(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){if(1===this.type){var t=this.coor,e=t[0],i=e[0],s=e[1],o=t[1];return[[i,s],[i+((r=o[0])-i)/2,s],[r,s],[r,s+((c=o[1])-s)/2],[r,c],[i+(r-i)/2,c],[i,c],[i,s+(c-s)/2]]}if(8===this.type){var n=this.coor,a=n[0],h=(i=a[0],s=a[1],n[1]),r=h[0],c=h[1],l=n[2],u=l[0],p=l[1],d=n[3],f=d[0],v=d[1];return[[i,s],[(i+r)/2,(s+c)/2],[r,c],[(r+u)/2,(c+p)/2],[u,p],[(u+f)/2,(p+v)/2],[f,v],[(f+i)/2,(v+s)/2]]}return[]},enumerable:!1,configurable:!0}),e}(i);var a=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const h=function(t){function e(e,i){var s=t.call(this,e,i)||this;return s.type=2,s}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return this.coor.length>2?this.coor:[]},enumerable:!1,configurable:!0}),e}(i);var r=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const c=function(t){function e(e,i){var s=t.call(this,e,i)||this;return s.type=3,s}return r(e,t),e}(i);const l=function(){function t(){this._eventTree={}}return t.prototype.on=function(t,e){var i=this._eventTree[t];Array.isArray(i)?i.push(e):this._eventTree[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var s=this._eventTree[t];Array.isArray(s)&&s.forEach((function(t){return t.apply(void 0,e)}))},t.prototype.off=function(t,e){var i=this._eventTree[t],s=i.find((function(t){return t===e}));Array.isArray(i)&&s&&i.splice(s,1)},t}();var u=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const p=function(t){function e(e,i){var s=t.call(this,e,i)||this;return s.type=4,s}return u(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return this.coor.length>1?this.coor:[]},enumerable:!1,configurable:!0}),e}(i);var d=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const f=function(t){function e(e,i){var s=t.call(this,e,i)||this;return s.type=5,s.radius=0,s.radius=e.radius||s.radius,s}return d(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){var t=this.coor,e=t[0],i=t[1];return[[e,i-this.radius],[e+this.radius,i],[e,i+this.radius],[e-this.radius,i]]},enumerable:!1,configurable:!0}),e}(i);var v=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}(),y=function(){return y=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},y.apply(this,arguments)},I=function(t){function e(e,i){var s=t.call(this)||this;s.lock=!1,s.MIN_WIDTH=10,s.MIN_HEIGHT=10,s.MIN_RADIUS=5,s.angleStep=30,s.strokeStyle="#0f0",s.lineWidth=3,s.fillStyle="rgba(0, 0, 255,0.1)",s.activeStrokeStyle="#f00",s.colors=["#f00","#FFFF00","#0000FF","#33ffff","#4B0082","#FFA500","#ff00ff","#008000"],s.count=0,s.isSame=!1,s.activeFillStyle="rgba(255, 0, 0,0.1)",s.ctrlStrokeStyle="#000",s.ctrlFillStyle="#fff",s.ctrlRadius=5,s.labelFillStyle="#fff",s.labelFont="16px sans-serif",s.textFillStyle="#000",s.labelMaxLen=10,s.isCursor=!0,s.cursorLineWidth=1,s.cursorLineDash=[5,5],s.cursorStrokeStyle="#f00",s.WIDTH=0,s.HEIGHT=0,s.dataset=[],s.rememberOrigin=[0,0],s.createType=0,s.ctrlIndex=-1,s.cursor="auto",s.image=new Image,s.IMAGE_WIDTH=0,s.IMAGE_ORIGIN_HEIGHT=0,s.IMAGE_HEIGHT=0,s.originX=0,s.originY=0,s.scaleStep=0,s.scrollZoom=!0,s.dblTouch=300,s.dblTouchStore=0,s.alpha=!0,s.focusMode=!1,s.scaleTouchStore=0,s.isTouch2=!1,s.handleLoad=s.handleLoad.bind(s),s.handleContextmenu=s.handleContextmenu.bind(s),s.handleMousewheel=s.handleMousewheel.bind(s),s.handleMouseDown=s.handleMouseDown.bind(s),s.handelMouseMove=s.handelMouseMove.bind(s),s.handelMouseUp=s.handelMouseUp.bind(s),s.handelDblclick=s.handelDblclick.bind(s),s.handelKeydown=s.handelKeydown.bind(s),s.initCanvas=s.initCanvas.bind(s),s.resize=s.resize.bind(s),s.revoke=s.revoke.bind(s);var o="string"==typeof e?document.querySelector(e):e;return o instanceof HTMLCanvasElement?(s.canvas=o,s.offScreen=document.createElement("canvas"),s.initSetting(),s.initEvents(),i&&s.setImage(i)):(s.canvas=null,console.warn("HTMLCanvasElement is required!")),s}return v(e,t),Object.defineProperty(e.prototype,"activeShape",{get:function(){return this.dataset.find((function(t){return t.active}))||{}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageMin",{get:function(){return Math.min(this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageOriginMax",{get:function(){return Math.max(this.IMAGE_ORIGIN_WIDTH,this.IMAGE_ORIGIN_HEIGHT)},enumerable:!1,configurable:!0}),e.prototype.initCanvas=function(t,e){var i="string"==typeof t?document.querySelector(t):t;i instanceof HTMLCanvasElement?(this.canvas=i,this.canvas.style.userSelect="none",this.initSetting(),this.initEvents(),e&&this.setImage(e)):console.warn("HTMLCanvasElement is required!")},e.prototype.mergeEvent=function(t){var e=0,i=0,s=0,o=0,n=!1;if(window.TouchEvent&&t instanceof window.TouchEvent){var a=t.touches[0],h=a.clientX,r=a.clientY,c=t.target.getBoundingClientRect(),l=c.left,u=c.top;if(e=Math.round(h-l),i=Math.round(r-u),2===t.touches.length){var p=t.touches[1]||{},d=p.clientX,f=void 0===d?0:d,v=p.clientY,I=void 0===v?0:v;s=Math.round(Math.abs((f-h)/2+h)-l),o=Math.round(Math.abs((I-r)/2+r)-u)}n=!0}else t instanceof MouseEvent?(e=t.offsetX,i=t.offsetY):(e=0,i=0);return y(y({},t),{mouseX:e,mouseY:i,mouseCX:s,mouseCY:o,isMobile:n})},e.prototype.handleLoad=function(){this.emit("load",this.image.src),this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom()},e.prototype.handleContextmenu=function(t){t.preventDefault(),this.evt=t,this.lock},e.prototype.handleMousewheel=function(t){if(t.stopPropagation(),this.evt=t,!this.lock&&this.scrollZoom){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;this.mouse=[i,s],this.setScale(t.deltaY<0,!0)}},e.prototype.handleMouseDown=function(t){var e=this;if(console.log("handleMouseDown",t),t.stopPropagation(),this.evt=t,!this.lock){var i=this.mergeEvent(t),s=i.mouseX,o=i.mouseY,a=i.mouseCX,r=i.mouseCY,l=window.TouchEvent&&t instanceof window.TouchEvent,u=Math.round(s/this.scale),d=Math.round(o/this.scale);if(this.mouse=l&&2===t.touches.length?[a,r]:[s,o],this.rememberOrigin=[s-this.originX,o-this.originY],!l&&t instanceof MouseEvent&&1===t.buttons||l&&1===t.touches.length){var v=this.activeShape.ctrlsData||[];if(this.ctrlIndex=v.findIndex((function(t){return e.isPointInCircle(e.mouse,t,e.ctrlRadius)})),this.ctrlIndex>-1){var y=v[this.ctrlIndex],I=y[0],S=y[1];this.remember=[[u-I,d-S]]}else if(this.isInBackground(t)){if(this.activeShape.creating){if([2,4].includes(this.activeShape.type)){var g=this.activeShape.coor[this.activeShape.coor.length-1],m=g[0],M=g[1];if(m!==u&&M!==d){var x=Math.round(u-this.originX/this.scale),b=Math.round(d-this.originY/this.scale);this.activeShape.coor.push([x,b])}}}else if(this.createType>0){var T={},E=[x=Math.round(u-this.originX/this.scale),b=Math.round(d-this.originY/this.scale)];switch(this.createType){case 1:(T=new n({coor:[E,E]},this.dataset.length)).creating=!0;break;case 8:(T=new n({coor:[E,E,E,E]},this.dataset.length,8)).creating=!0;break;case 2:(T=new h({coor:[E]},this.dataset.length)).creating=!0;break;case 3:T=new c({coor:E},this.dataset.length),this.emit("add",T);break;case 4:(T=new p({coor:[E]},this.dataset.length)).creating=!0;break;case 5:(T=new f({coor:E},this.dataset.length)).creating=!0}this.dataset.forEach((function(t){t.active=!1})),T.active=!0,console.log("newShape===>>>",T),T=this.updateCount(T),this.dataset.push(T)}else{var H=this.hitOnShape(this.mouse),w=H[0],_=H[1];if(w>-1){if(this.dataset.forEach((function(t,e){return t.active=e===w})),_.dragging=!0,this.dataset.splice(w,1),this.dataset.push(_),this.remember=[],[3,5].includes(_.type)){var G=_.coor;m=G[0],M=G[1];this.remember=[[u-m,d-M]]}else _.coor.forEach((function(t){e.remember.push([u-t[0],d-t[1]])}));this.emit("select",_)}else this.activeShape.active=!1}this.update()}}}},e.prototype.handelMouseMove=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY,o=e.mouseCX,n=e.mouseCY,a=window.TouchEvent&&t instanceof window.TouchEvent,h=Math.round(i/this.scale),r=Math.round(s/this.scale);if(this.mouse=a&&2===t.touches.length?[o,n]:[i,s],(!a&&1===t.buttons||a&&1===t.touches.length)&&this.activeShape.type){if(this.ctrlIndex>-1&&(this.isInBackground(t)||5===this.activeShape.type)){var c=this.remember[0],l=c[0],u=c[1];if(1===this.activeShape.type){var p=this.activeShape.coor,d=p[0],f=d[0],v=d[1],y=p[1],I=y[0],S=y[1],g=[];switch(this.ctrlIndex){case 0:g=[[h-l,r-u],[I,S]];break;case 1:g=[[f,r-u],[I,S]];break;case 2:g=[[f,r-u],[h-l,S]];break;case 3:g=[[f,v],[h-l,S]];break;case 4:g=[[f,v],[h-l,r-u]];break;case 5:g=[[f,v],[I,r-u]];break;case 6:g=[[h-l,v],[I,r-u]];break;case 7:g=[[h-l,v],[I,S]]}var m=g[0],M=m[0],x=m[1],b=g[1],T=b[0],E=b[1];(M<0||T<0||x<0||E<0||T>this.IMAGE_ORIGIN_WIDTH||E>this.IMAGE_ORIGIN_HEIGHT)&&(console.log("超出边界"),M<0&&(M=0),T<0&&(T=0),x<0&&(x=0),E<0&&(E=0),T>this.IMAGE_ORIGIN_WIDTH&&(T=this.IMAGE_ORIGIN_WIDTH),E>this.IMAGE_ORIGIN_HEIGHT&&(E=this.IMAGE_ORIGIN_HEIGHT)),T-M>=this.MIN_WIDTH&&E-x>=this.MIN_HEIGHT?this.activeShape.coor=[[M,x],[T,E]]:this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than").concat(this.MIN_HEIGHT,"。"))}else if(8===this.activeShape.type)this.activeShape.coor=this.updateRotateRectangleSize(this.activeShape.ctrlsData||[],this.ctrlIndex,h-l,r-u);else if([2,4].includes(this.activeShape.type)){var H=[Math.round(h-this.originX/this.scale),Math.round(r-this.originY/this.scale)];this.activeShape.coor.splice(this.ctrlIndex,1,H)}else if(5===this.activeShape.type){var w=Math.round(h-this.originX/this.scale)-this.activeShape.coor[0];w>=this.MIN_RADIUS&&(this.activeShape.radius=w)}}else if(this.activeShape.dragging){g=[];var _=!0,G=this.IMAGE_ORIGIN_WIDTH||this.WIDTH,k=this.IMAGE_ORIGIN_HEIGHT||this.HEIGHT;if([3,5].includes(this.activeShape.type)){var D=this.remember[0],O=D[0];u=r-D[1];((l=h-O)<0||l>G||u<0||u>k)&&(_=!1),g=[l,u]}else for(var A=0;A<this.activeShape.coor.length;A++){var W=this.remember[A];l=h-W[0],u=r-W[1];(l<0||l>G||u<0||u>k)&&(_=!1),g.push([l,u])}_&&(this.activeShape.coor=g)}else if(this.activeShape.creating&&this.isInBackground(t)){l=Math.round(h-this.originX/this.scale),u=Math.round(r-this.originY/this.scale);if([1,8].includes(this.activeShape.type)){if(this.activeShape.coor.splice(1,1,[l,u]),8===this.activeShape.type){var C=this.activeShape.coor,P=C[0],L=(f=P[0],v=P[1],C[1]);I=L[0],S=L[1];this.activeShape.coor=[[f,v],[I,v],[I,S],[f,S]]}}else if(5===this.activeShape.type){var R=this.activeShape.coor,N=(f=R[0],v=R[1],Math.sqrt(Math.pow(f-l,2)+Math.pow(v-u,2)));this.activeShape.radius=N}}this.update()}else if([2,4].includes(this.activeShape.type)&&this.activeShape.creating)this.update();else if(!a&&t instanceof MouseEvent&&2===t.buttons&&3===t.which||a&&1===t.touches.length&&!this.isTouch2)this.originX=Math.round(i-this.rememberOrigin[0]),this.originY=Math.round(s-this.rememberOrigin[1]),this.update();else if(a&&2===t.touches.length){this.isTouch2=!0;var F=t.touches[0],j=t.touches[1],X=this.scaleTouchStore;this.scaleTouchStore=Math.abs((j.clientX-F.clientX)*(j.clientY-F.clientY)),this.setScale(this.scaleTouchStore>X,!0)}this.update()}},e.prototype.updateRotateRectangleSize=function(t,e,i,s){var o=t.reduce((function(e,i){return[e[0]+i[0]/t.length,e[1]+i[1]/t.length]}),[0,0]);if(e%2==0)for(var n=Math.atan2(s-o[1],i-o[0]),a=Math.atan2(t[e][1]-o[1],t[e][0]-o[0]),h=Math.hypot(i-o[0],s-o[1])/Math.hypot(t[e][0]-o[0],t[e][1]-o[1]),r=n-a,c=0;c<t.length;c++){var l=Math.atan2(t[c][1]-o[1],t[c][0]-o[0])+r,u=Math.hypot(t[c][0]-o[0],t[c][1]-o[1])*h;t[c]=[o[0]+Math.cos(l)*u,o[1]+Math.sin(l)*u]}else{var p=(e-1+t.length)%t.length,d=(e+1)%t.length,f=t[d][0]-t[p][0],v=t[d][1]-t[p][1],y=Math.hypot(f,v),I=((i-t[p][0])*f+(s-t[p][1])*v)/y,S=i-(f/y*I+t[p][0]),g=s-(v/y*I+t[p][1]);t[p][0]+=S,t[p][1]+=g,t[d][0]+=S,t[d][1]+=g,t[e][0]=i,t[e][1]=s}return t.filter((function(t,e){return e%2==0}))},e.prototype.handelMouseUp=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){if(window.TouchEvent&&t instanceof window.TouchEvent){if(0===t.touches.length&&(this.isTouch2=!1),Date.now()-this.dblTouchStore<this.dblTouch)return void this.handelDblclick(t);this.dblTouchStore=Date.now()}if(this.remember=[],this.activeShape.type&&(this.activeShape.dragging=!1,this.activeShape.creating)){if(1===this.activeShape.type){var e=this.activeShape.coor,i=e[0],s=i[0],o=i[1],n=e[1],a=n[0],h=n[1];if(Math.abs(s-a)<this.MIN_WIDTH||Math.abs(o-h)<this.MIN_HEIGHT)this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT));else{var r=this.activeShape.coor,c=r[0],l=c[0],u=c[1],p=r[1],d=p[0],f=p[1];this.activeShape.coor=[[Math.min(l,d),Math.min(u,f)],[Math.max(l,d),Math.max(u,f)]],this.activeShape.creating=!1,this.emit("add",this.activeShape)}}else if(8===this.activeShape.type){var v=this.activeShape.coor,y=v[0],I=(s=y[0],o=y[1],v[1]),S=(a=I[0],h=I[1],v[2]),g=S[0],m=S[1],M=v[3],x=M[0],b=M[1];Math.abs(s-g)<this.MIN_WIDTH||Math.abs(o-m)<this.MIN_HEIGHT?(this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT))):(this.activeShape.coor=[[Math.min(s,a,g,x),Math.min(o,h,m,b)],[Math.max(s,a,g,x),Math.min(o,h,m,b)],[Math.max(s,a,g,x),Math.max(o,h,m,b)],[Math.min(s,a,g,x),Math.max(o,h,m,b)]],this.activeShape.creating=!1,this.emit("add",this.activeShape))}else 5===this.activeShape.type&&(this.activeShape.radius<this.MIN_RADIUS?(this.dataset.pop(),this.emit("warn","Radius cannot be less than ".concat(this.MIN_WIDTH))):(this.activeShape.creating=!1,this.emit("add",this.activeShape)));this.update()}}},e.prototype.handelDblclick=function(t){t.stopPropagation(),this.evt=t,this.lock||[2,4].includes(this.activeShape.type)&&(2===this.activeShape.type&&this.activeShape.coor.length>2||4===this.activeShape.type&&this.activeShape.coor.length>1)&&(this.emit("add",this.activeShape),this.activeShape.creating=!1,this.update())},e.prototype.handelKeydown=function(t){t.stopPropagation(),this.evt=t,this.lock||document.activeElement!==document.body||(this.activeShape.type&&([1,2,4].includes(this.activeShape.type)&&("ArrowUp"===t.key?this.activeShape.coor=this.activeShape.coor.map((function(t){return[t[0],t[1]-1]})):"ArrowDown"===t.key?this.activeShape.coor=this.activeShape.coor.map((function(t){return[t[0],t[1]+1]})):"ArrowLeft"===t.key?this.activeShape.coor=this.activeShape.coor.map((function(t){return[t[0]-1,t[1]]})):"ArrowRight"===t.key&&(this.activeShape.coor=this.activeShape.coor.map((function(t){return[t[0]+1,t[1]]})))),5===this.activeShape.type&&("ArrowUp"===t.key?this.activeShape.radius-=1:"ArrowDown"===t.key&&(this.activeShape.radius+=1)),3===this.activeShape.type&&("ArrowUp"===t.key?this.activeShape.coor[1]-=1:"ArrowDown"===t.key?this.activeShape.coor[1]+=1:"ArrowLeft"===t.key?this.activeShape.coor[0]-=1:"ArrowRight"===t.key&&(this.activeShape.coor[0]+=1)),[2,4].includes(this.activeShape.type)&&"Escape"===t.key?this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index):[1,8,3,5].includes(this.activeShape.type)&&"Escape"===t.key&&this.deleteByIndex(this.activeShape.index)),"Backspace"!==t.key&&"Delete"!==t.key||this.deleteByIndex(this.activeShape.index),2===this.activeShape.type&&"Enter"===t.key&&(console.log("123123"),this.handelDblclick(t)),"Digit1"===t.code&&t.shiftKey?this.createType=1:"Digit2"===t.code&&t.shiftKey?this.createType=2:"Digit3"===t.code&&t.shiftKey?this.createType=3:"Digit4"===t.code&&t.shiftKey?this.createType=4:"Digit5"===t.code&&t.shiftKey?this.createType=5:"Digit8"===t.code&&t.shiftKey?this.createType=8:"Backquote"===t.code&&t.shiftKey?this.createType=0:"KeyZ"===t.code&&t.ctrlKey&&this.rotate())},e.prototype.rotate=function(){if(console.log("this.activeShape",this.activeShape),this.lock||document.activeElement!==document.body||8!==this.activeShape.type||!this.activeShape.coor)return!1;this.update(this.angleStep)},e.prototype.revoke=function(){this.lock||document.activeElement!==document.body||this.activeShape.type&&([2,4].includes(this.activeShape.type)?this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index):[1,8,3,5].includes(this.activeShape.type)&&this.deleteByIndex(this.activeShape.index),this.update())},e.prototype.initSetting=function(){var t=window.devicePixelRatio||1;this.canvas.style.userSelect="none",this.ctx=this.canvas.getContext("2d",{alpha:this.alpha}),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientHeight,this.canvas.width=this.WIDTH*t,this.canvas.height=this.HEIGHT*t,this.canvas.style.width=this.WIDTH+"px",this.canvas.style.height=this.HEIGHT+"px",this.offScreen=document.createElement("canvas"),this.offScreen.width=this.WIDTH,this.offScreen.height=this.HEIGHT,this.offScreenCtx=this.offScreenCtx||this.offScreen.getContext("2d",{willReadFrequently:!0}),this.ctx.scale(t,t)},e.prototype.initEvents=function(){this.image.addEventListener("load",this.handleLoad),this.canvas.addEventListener("touchstart",this.handleMouseDown),this.canvas.addEventListener("touchmove",this.handelMouseMove),this.canvas.addEventListener("touchend",this.handelMouseUp),this.canvas.addEventListener("contextmenu",this.handleContextmenu),this.canvas.addEventListener("wheel",this.handleMousewheel),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handelMouseMove),this.canvas.addEventListener("mouseup",this.handelMouseUp),this.canvas.addEventListener("dblclick",this.handelDblclick),document.body.addEventListener("keydown",this.handelKeydown),window.addEventListener("resize",this.resize)},e.prototype.setImage=function(t){this.image.src=t},e.prototype.setData=function(t){var e=this;setTimeout((function(){var i=[];t.forEach((function(t,e){if(Object.prototype.toString.call(t).indexOf("Object")>-1){var s={};switch(t.type){case 1:s=new n(t,e,1);break;case 8:s=new n(t,e,8);break;case 2:s=new h(t,e);break;case 3:s=new c(t,e);break;case 4:s=new p(t,e);break;case 5:s=new f(t,e);break;default:console.warn("Invalid shape",t)}[1,8,2,3,4,5].includes(t.type)&&i.push(s)}else console.warn("Shape must be an enumerable Object.",t)})),e.dataset=i,e.update()}))},e.prototype.hitOnShape=function(t){for(var e=-1,i={},s=this.dataset.length-1;s>-1;s--){var o=this.dataset[s];if(3===o.type&&this.isPointInCircle(t,o.coor,this.ctrlRadius)||5===o.type&&this.isPointInCircle(t,o.coor,o.radius*this.scale)||1===o.type&&this.isPointInRect(t,o.coor)||(2===o.type||8===o.type)&&this.isPointInPolygon(t,o.coor)||4===o.type&&this.isPointInLine(t,o.coor)){if(this.focusMode&&!o.active)continue;e=s,i=o;break}}return[e,i]},e.prototype.isInBackground=function(t){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;return i>=this.originX&&s>=this.originY&&i<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale&&s<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale},e.prototype.isPointInRect=function(t,e){var i=this,s=t[0],o=t[1],n=e.map((function(t){return t.map((function(t){return t*i.scale}))})),a=n[0],h=a[0],r=a[1],c=n[1],l=c[0],u=c[1];return h+this.originX<=s&&s<=l+this.originX&&r+this.originY<=o&&o<=u+this.originY},e.prototype.isPointInPolygon=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.beginPath(),e.forEach((function(t,e){var s=t.map((function(t){return Math.round(t*i.scale)})),o=s[0],n=s[1];0===e?i.offScreenCtx.moveTo(o,n):i.offScreenCtx.lineTo(o,n)})),this.offScreenCtx.closePath(),this.offScreenCtx.fill();var s=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),o=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==s.data[o+3]},e.prototype.isPointInCircle=function(t,e,i){var s=this,o=t[0],n=t[1],a=e.map((function(t){return t*s.scale})),h=a[0],r=a[1];return Math.sqrt(Math.pow(h+this.originX-o,2)+Math.pow(r+this.originY-n,2))<=2*i},e.prototype.isPointInLine=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.lineWidth=5,this.offScreenCtx.beginPath(),e.forEach((function(t,e){var s=t.map((function(t){return Math.round(t*i.scale)})),o=s[0],n=s[1];0===e?i.offScreenCtx.moveTo(o,n):i.offScreenCtx.lineTo(o,n)})),this.offScreenCtx.stroke();var s=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),o=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==s.data[o+3]},e.prototype.drawRect=function(t){var e=this;if(2===t.coor.length){var i=t.labelFillStyle,s=t.textFillStyle,o=t.labelFont,n=t.strokeStyle,a=t.fillStyle,h=t.active,r=t.creating,c=t.coor,l=t.label,u=t.count,p=c.map((function(t){return t.map((function(t){return Math.round(t*e.scale)}))})),d=p[0],f=d[0],v=d[1],y=p[1],I=y[0],S=y[1];this.ctx.save(),this.ctx.fillStyle=a||this.fillStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.strokeStyle=h||r?this.activeStrokeStyle:n||this.strokeStyle;var g=I-f,m=S-v;this.ctx.strokeRect(f,v,g,m),r||this.ctx.fillRect(f,v,g,m),this.ctx.restore(),this.drawLabel(c[0],l,i,o,s,u)}},e.prototype.drawRotateRect=function(t,e){var i=this;void 0===e&&(e=0);var s=t.labelFillStyle,o=t.textFillStyle,n=t.labelFont,a=t.strokeStyle,h=t.fillStyle,r=t.active,c=t.creating,l=t.coor,u=t.label,p=t.count;if(4===t.coor.length){r||(e=0);var d=l.map((function(t){return t.map((function(t){return t*i.scale}))})),f=d[0],v=f[0],y=f[1],I=d[1],S=I[0],g=I[1],m=d[2],M=m[0],x=m[1],b=d[3],T=b[0],E=b[1],H=(v+S+M+T)/4,w=(y+g+x+E)/4,_=e*Math.PI/180,G=Math.cos(_),k=Math.sin(_),D=G*(v-H)-k*(y-w)+H,O=k*(v-H)+G*(y-w)+w,A=G*(S-H)-k*(g-w)+H,W=k*(S-H)+G*(g-w)+w,C=G*(M-H)-k*(x-w)+H,P=k*(M-H)+G*(x-w)+w,L=G*(T-H)-k*(E-w)+H,R=k*(T-H)+G*(E-w)+w;r&&(this.activeShape.coor=[[D,O],[A,W],[C,P],[L,R]].map((function(t){return t.map((function(t){return t/i.scale}))}))),this.ctx.save(),this.ctx.fillStyle=h||this.fillStyle,this.ctx.strokeStyle=r||c?this.activeStrokeStyle:a||this.strokeStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.beginPath(),this.ctx.moveTo(D,O),this.ctx.lineTo(A,W),this.ctx.moveTo(A,W),this.ctx.lineTo(C,P),this.ctx.moveTo(C,P),this.ctx.lineTo(L,R),this.ctx.moveTo(L,R),this.ctx.lineTo(D,O),this.ctx.closePath(),this.ctx.stroke(),c||this.ctx.fill(),this.ctx.restore(),this.drawLabel(l[0],u,s,n,o,p)}},e.prototype.drawPolygon=function(t){var e=this,i=t.labelFillStyle,s=t.textFillStyle,o=t.labelFont,n=t.strokeStyle,a=t.fillStyle,h=t.active,r=t.creating,c=t.coor,l=t.label,u=t.count;if(this.ctx.save(),this.ctx.fillStyle=a||this.fillStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.strokeStyle=h||r?this.activeStrokeStyle:n||this.strokeStyle,this.ctx.beginPath(),c.forEach((function(t,i){var s=t.map((function(t){return Math.round(t*e.scale)})),o=s[0],n=s[1];0===i?e.ctx.moveTo(o,n):e.ctx.lineTo(o,n)})),r){var p=this.mouse||[],d=p[0],f=p[1];this.ctx.lineTo(d-this.originX,f-this.originY)}else c.length>2&&this.ctx.closePath();this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(c[0],l,i,o,s,u)},e.prototype.drawDot=function(t){var e=this,i=t.labelFillStyle,s=t.textFillStyle,o=t.labelFont,n=t.strokeStyle,a=t.fillStyle,h=t.active,r=t.coor,c=t.label,l=r.map((function(t){return t*e.scale})),u=l[0],p=l[1];this.ctx.save(),this.ctx.fillStyle=a||this.ctrlFillStyle,this.ctx.strokeStyle=h?this.activeStrokeStyle:n||this.strokeStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.beginPath(),this.ctx.arc(u,p,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(u,p,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(r,c,i,o,s)},e.prototype.drawCirle=function(t){var e=this,i=t.labelFillStyle,s=t.textFillStyle,o=t.labelFont,n=t.strokeStyle,a=t.fillStyle,h=t.active,r=t.coor,c=t.label,l=t.creating,u=t.radius,p=t.ctrlsData,d=r.map((function(t){return t*e.scale})),f=d[0],v=d[1];this.ctx.save(),this.ctx.fillStyle=a||this.fillStyle,this.ctx.strokeStyle=h||l?this.activeStrokeStyle:n||this.strokeStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.beginPath(),this.ctx.arc(f,v,u*this.scale,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(f,v,u*this.scale,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(p[0],c,i,o,s)},e.prototype.drawLine=function(t){var e=this;try{var i=t.labelFillStyle,s=t.textFillStyle,o=t.labelFont,n=t.strokeStyle,a=t.active,h=t.creating,r=t.coor,c=t.label;if(this.ctx.save(),this.ctx.strokeStyle=a||h?this.activeStrokeStyle:n||this.strokeStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.beginPath(),r.forEach((function(t,i){var s=t.map((function(t){return Math.round(t*e.scale)})),o=s[0],n=s[1];0===i?e.ctx.moveTo(o,n):e.ctx.lineTo(o,n)})),h){var l=this.mouse||[],u=l[0],p=l[1];this.ctx.lineTo(u-this.originX,p-this.originY)}this.ctx.stroke(),this.ctx.restore(),this.drawLabel(r[0],c,i,o,s)}catch(t){console.log("error",t)}},e.prototype.drawCursorLine=function(){if(this.isInBackground(this.evt)){var t=this.mergeEvent(this.evt),e=t.mouseX,i=t.mouseY;this.ctx.restore(),this.ctx.save(),this.ctx.setLineDash(this.cursorLineDash),this.ctx.lineWidth=this.cursorLineWidth,this.ctx.strokeStyle=this.cursorStrokeStyle,this.ctx.beginPath(),this.ctx.moveTo(this.originX,i),this.ctx.lineTo(this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale,i),this.ctx.moveTo(e,this.originY),this.ctx.lineTo(e,this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale),this.ctx.stroke(),this.ctx.restore(),this.ctx.save()}},e.prototype.drawCtrl=function(t){var e=this,i=t.map((function(t){return t*e.scale})),s=i[0],o=i[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(s,o,this.ctrlRadius,0,4*Math.PI,!0),this.ctx.fill(),this.ctx.arc(s,o,this.ctrlRadius,0,4*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},e.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(i,s){5===t.type?1===s&&e.drawCtrl(i):e.drawCtrl(i)}))},e.prototype.drawLabel=function(t,e,i,s,o,n){var a=this;if(void 0===e&&(e=""),void 0===i&&(i=""),void 0===s&&(s=""),void 0===o&&(o=""),void 0===n&&(n=0),e.length){this.ctx.font=s||this.labelFont;var h=parseInt(this.ctx.font)+6,r=e.length<this.labelMaxLen+1?e:"".concat(e.slice(0,this.labelMaxLen),"..."),c=this.ctx.measureText(r),l=t.map((function(t){return t*a.scale})),u=l[0],p=l[1],d=this.IMAGE_ORIGIN_WIDTH-t[0]<(c.width+4)/this.scale,f=this.IMAGE_ORIGIN_HEIGHT-t[1]<h/this.scale;this.ctx.save(),this.ctx.fillStyle=i||this.labelFillStyle,this.ctx.fillRect(d?u-c.width-3:u+1,f?p-h+3:p+1,c.width+40,h),this.ctx.fillStyle=o||this.textFillStyle,this.ctx.fillText(r,d?u-c.width-2:u+2,f?p-3:p+h-4,180),this.ctx.fillStyle="red",this.ctx.font="18px Arial",this.ctx.fillText(n,d?u+20:u+c.width+20,f?p-3:p+h-4,180),this.ctx.restore()}},e.prototype.updateCount=function(t){return this.count=this.dataset.length&&this.dataset[this.dataset.length-1].count||0,this.isSame||this.count++,t&&t.active&&(t.count=this.count),t.strokeStyle=this.colors[this.count]||this.strokeStyle,t},e.prototype.update=function(t){var e=this;void 0===t&&(t=0),clearTimeout(this.timer),this.timer=setTimeout((function(){e.ctx.save(),e.ctx.clearRect(0,0,e.WIDTH,e.HEIGHT),e.ctx.translate(e.originX,e.originY),e.IMAGE_WIDTH&&e.IMAGE_HEIGHT&&e.ctx.drawImage(e.image,0,0,e.IMAGE_WIDTH,e.IMAGE_HEIGHT);for(var i=e.focusMode?e.activeShape.type?[e.activeShape]:[]:e.dataset,s=0;s<i.length;s++){var o=i[s];if(!o.hide)switch(o.type){case 1:e.drawRect(o);break;case 8:e.drawRotateRect(o,t);break;case 2:e.drawPolygon(o);break;case 3:e.drawDot(o);break;case 4:e.drawLine(o);break;case 5:e.drawCirle(o)}}[1,8,2,4,5].includes(e.activeShape.type)&&!e.activeShape.hide&&e.drawCtrlList(e.activeShape),e.isCursor&&e.drawCursorLine(),e.ctx.restore(),e.emit("updated",e.dataset)}),0)},e.prototype.deleteByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));e>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1),this.dataset.forEach((function(t,e){t.index=e})),this.update())},e.prototype.calcStep=function(t){void 0===t&&(t=""),this.IMAGE_WIDTH<this.WIDTH&&this.IMAGE_HEIGHT<this.HEIGHT&&(""!==t&&"b"!==t||(this.setScale(!0,!1,!0),this.calcStep("b"))),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(""!==t&&"s"!==t||(this.setScale(!1,!1,!0),this.calcStep("s")))},e.prototype.setScale=function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1);var s=Math.min(this.imageMin,50);if(!(!t&&this.imageMin<s||t&&this.IMAGE_WIDTH>=10*this.imageOriginMax)){t?this.scaleStep++:this.scaleStep--;var o=0,n=0,a=this.mouse||[],h=a[0],r=a[1];e&&(o=(h-this.originX)/this.scale,n=(r-this.originY)/this.scale);var c=Math.abs(this.scaleStep),l=this.IMAGE_WIDTH;if(this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(this.scaleStep>=0?1.05:.95,c)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(this.scaleStep>=0?1.05:.95,c)),e)this.originX=h-o*this.scale,this.originY=r-n*this.scale;else{var u=this.IMAGE_WIDTH/l;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*u,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*u}i||this.update()}},e.prototype.fitZoom=function(){this.calcStep(),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()},e.prototype.setFocusMode=function(t){this.focusMode=t,this.update()},e.prototype.resize=function(){this.canvas.width=null,this.canvas.height=null,this.canvas.style.width=null,this.canvas.style.height=null,this.handleLoad(),this.initSetting(),this.update()},e.prototype.destroy=function(){this.canvas&&(this.image.removeEventListener("load",this.handleLoad),this.canvas.removeEventListener("contextmenu",this.handleContextmenu),this.canvas.removeEventListener("wheel",this.handleMousewheel),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("touchend",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handelMouseMove),this.canvas.removeEventListener("touchmove",this.handelMouseMove),this.canvas.removeEventListener("mouseup",this.handelMouseUp),this.canvas.removeEventListener("touchend",this.handelMouseUp),this.canvas.removeEventListener("dblclick",this.handelDblclick),document.body.removeEventListener("keydown",this.handelKeydown),window.removeEventListener("resize",this.resize),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="0",this.canvas.style.height="0",this.canvas.style.userSelect="none")},e}(l);const S=I;return e})()));